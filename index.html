<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§ˆí”¼ì•„ ì—­í•  ë¶€ì—¬ (Custom Modal)</title>

  <style>
    body { font-family: system-ui, sans-serif; text-align: center; padding: 20px; background-color: #f9f9f9; }
    h1 { margin-bottom: 10px; }
    input, button { padding: 10px; margin: 6px; font-size: 14px; border-radius: 6px; border: 1px solid #ccc; }
    button { cursor: pointer; transition: background 0.2s; }
    button:active { transform: scale(0.98); }
    
    #lobby { display:none; }
    #roleSetup { display:none; margin-top: 12px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #hostArea { display:none; margin-top: 10px; padding: 10px; background: #eef4ff; border-radius: 8px; }
    
    #authStatus { font-size: 12px; opacity: .8; margin-bottom: 10px; }
    #hint { font-size: 13px; color: #555; margin-top: 6px; font-weight: bold; }
    
    #roomStatus {
      font-size: 13px; color: #333; margin: 12px auto 0; white-space: pre-line;
      text-align: left; max-width: 600px;
      background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    ul { list-style:none; padding-left: 0; }
    li { padding: 5px 0; border-bottom: 1px solid #eee; }
    
    #myRole { font-size: 20px; font-weight: bold; margin: 20px 0; padding: 15px; background: #fff8e1; border-radius: 8px; border: 2px solid #ffe082; min-height: 24px;}
    #adminRoles { margin-top: 12px; color: #7a0000; text-align: left; background: #fff0f0; padding: 10px; border-radius: 8px; }
    
    .row { display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; }
    .box { max-width: 600px; margin: 0 auto; }
    .roleRow { display:flex; gap:8px; justify-content:center; margin: 6px 0; align-items: center; }
    .roleRow input[type="text"] { width: 120px; }
    .roleRow input[type="number"] { width: 60px; text-align: center; }
    
    .danger { background:#e74c3c; color:white; border:none; }
    .danger:hover { background:#c0392b; }
    
    .primary { background:#3498db; color:white; border:none; }
    .primary:hover { background:#2980b9; }
    
    .ghost { background:#f1f2f6; border:1px solid #dcdde1; color: #333; }
    .ghost:hover { background:#dfe4ea; }
    
    .muted { opacity:.7; font-size: 0.9em; }
    
    /* Toast Message */
    #toast {
      visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
      text-align: center; border-radius: 4px; padding: 16px; position: fixed;
      z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* Custom Modal Styles */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 2000;
      display: none; justify-content: center; align-items: center;
    }
    .modal-box {
      background: white; padding: 25px; border-radius: 12px;
      max-width: 80%; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      text-align: left;
    }
    .modal-msg { margin-bottom: 20px; font-size: 16px; line-height: 1.5; color: #333; }
    .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, getDocs, onSnapshot, writeBatch, query, limit, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* =========================
       0) Firebase ì„¤ì •
    ========================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBCI97ApSsXtNqUnKTdzEW6bvtaF-bHrgs",
      authDomain: "role-class.firebaseapp.com",
      projectId: "role-class",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /* =========================
       1) ìƒíƒœ ë³€ìˆ˜
    ========================== */
    let myId = null;
    let myRoom = "";
    let isHost = false;

    let unsubRoom = null;
    let unsubRoster = null;
    let unsubMyPrivate = null;
    let unsubHostPrivate = null;

    const $ = (id) => document.getElementById(id);

    // Toast
    function showToast(msg) {
      const x = $("toast");
      if(x) {
          x.textContent = msg;
          x.className = "show";
          setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
      }
      console.log(`[TOAST] ${msg}`);
    }

    // Custom Modal Function (Replaces alert/confirm)
    function openModal(msg, isConfirm = false) {
      return new Promise((resolve) => {
        const overlay = $("modalOverlay");
        const msgEl = $("modalMsg");
        const okBtn = $("modalOkBtn");
        const cancelBtn = $("modalCancelBtn");

        msgEl.textContent = msg;
        overlay.style.display = "flex";
        
        cancelBtn.style.display = isConfirm ? "block" : "none";
        
        // Remove old listeners (cloning node is a quick hack to wipe listeners)
        const newOk = okBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOk, okBtn);
        
        const newCancel = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

        newOk.onclick = () => {
          overlay.style.display = "none";
          resolve(true);
        };
        
        newCancel.onclick = () => {
          overlay.style.display = "none";
          resolve(false);
        };
      });
    }

    async function showAlert(msg) {
      await openModal(msg, false);
    }

    async function showConfirm(msg) {
      return await openModal(msg, true);
    }

    function setStatus(text) {
      if($("roomStatus")) $("roomStatus").textContent = text || "";
    }

    function stopAllListeners() {
      if (unsubRoom) { unsubRoom(); unsubRoom = null; }
      if (unsubRoster) { unsubRoster(); unsubRoster = null; }
      if (unsubMyPrivate) { unsubMyPrivate(); unsubMyPrivate = null; }
      if (unsubHostPrivate) { unsubHostPrivate(); unsubHostPrivate = null; }
    }

    function setBusy(busy) {
      const btns = ["joinBtn", "leaveBtn", "assignBtn", "resetBtn", "addRoleBtn"];
      btns.forEach(id => {
        const el = $(id);
        if(el) el.disabled = busy;
      });
      // ë¡œê·¸ì¸ ì „ì´ë©´ joinBtnì€ ê³„ì† ë¹„í™œì„±ì¼ ìˆ˜ ìˆìŒ
      if (!myId && $("joinBtn")) $("joinBtn").disabled = true;
      
      const inputs = ["roomInput", "nameInput"];
      inputs.forEach(id => {
        const el = $(id);
        if(el) el.disabled = busy;
      });
    }

    function showJoinScreen() {
      $("join").style.display = "block";
      $("lobby").style.display = "none";
      $("roleSetup").style.display = "none";
      $("hostArea").style.display = "none";

      $("players").innerHTML = "";
      $("adminRoles").innerHTML = "";
      $("myRole").textContent = "";
      $("hostTag").textContent = "";
      $("hint").textContent = "ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ìƒˆ ë°©ì¸ì§€/ê¸°ì¡´ ë°©ì¸ì§€ ì•ˆë‚´í•©ë‹ˆë‹¤.";
      setStatus("");
    }

    function showLobbyScreen() {
      $("join").style.display = "none";
      $("lobby").style.display = "block";
    }

    /* =========================
       2) ìœ í‹¸: íƒ€ì„ì•„ì›ƒ ë˜í¼
    ========================== */
    function withTimeout(promise, ms, label) {
      return new Promise((resolve, reject) => {
        const t = setTimeout(() => reject(new Error(`TIMEOUT: ${label}`)), ms);
        promise.then((v) => { clearTimeout(t); resolve(v); })
               .catch((e) => { clearTimeout(t); reject(e); });
      });
    }

    /* =========================
       3) ì—­í•  ì„¤ì • UI
    ========================== */
    function getRolesConfigFromUI() {
      const names = document.querySelectorAll(".roleName");
      const counts = document.querySelectorAll(".roleCount");
      const config = {};
      names.forEach((n, i) => {
        const role = n.value.trim();
        const count = parseInt(counts[i].value, 10);
        if (role && Number.isFinite(count) && count > 0) config[role] = count;
      });
      return config;
    }

    function addRoleRow() {
      const div = document.createElement("div");
      div.className = "roleRow";
      div.innerHTML = `
        <input class="roleName" type="text" placeholder="ì—­í•  ì´ë¦„"/>
        <input class="roleCount" type="number" min="1" value="1"/>
        <button class="ghost removeRoleBtn" type="button">ğŸ—‘ï¸</button>
      `;
      div.querySelector(".removeRoleBtn").addEventListener("click", () => div.remove());
      $("roles").appendChild(div);
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    /* =========================
       4) ë°© ì¡´ì¬ í™•ì¸
    ========================== */
    let roomCheckTimer = null;
    async function onRoomInputChange() {
      const code = $("roomInput").value.trim();
      if (!myId) {
        $("hint").textContent = "ë¡œê·¸ì¸ ì¤‘...";
        $("roleSetup").style.display = "none";
        return;
      }
      if (!code) {
        $("hint").textContent = "ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        $("roleSetup").style.display = "none";
        return;
      }

      clearTimeout(roomCheckTimer);
      roomCheckTimer = setTimeout(async () => {
        try {
          const snap = await withTimeout(getDoc(doc(db, "rooms", code)), 4000, "checkRoom");
          if (snap.exists()) {
            $("hint").textContent = "âœ… ê¸°ì¡´ ë°©ì…ë‹ˆë‹¤. ì°¸ê°€ìë¡œ ì…ì¥í•©ë‹ˆë‹¤.";
            $("roleSetup").style.display = "none";
          } else {
            $("hint").textContent = "ğŸ†• ìƒˆ ë°©ì…ë‹ˆë‹¤. (ë°©ì¥ - ì—­í•  ì„¤ì • í•„ìš”)";
            $("roleSetup").style.display = "block";
          }
        } catch (e) {
          console.error(e);
          $("hint").textContent = "ë°© í™•ì¸ ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)";
          $("roleSetup").style.display = "none";
        }
      }, 250);
    }

    /* =========================
       5) Firestore ê²½ë¡œ
    ========================== */
    const roomRef = (code) => doc(db, "rooms", code);
    const rosterRef = (code, uid) => doc(db, `rooms/${code}/roster/${uid}`);
    const privateRef = (code, uid) => doc(db, `rooms/${code}/privatePlayers/${uid}`);

    /* =========================
       6) ì…ì¥ (Join)
    ========================== */
    async function joinRoom() {
      console.log(">> joinRoom clicked");
      const name = $("nameInput").value.trim();
      const code = $("roomInput").value.trim();
      if (!name || !code) { await showAlert("ì´ë¦„ê³¼ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
      if (!myId) { await showAlert("ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."); return; }

      setBusy(true);
      stopAllListeners();
      myRoom = code;
      isHost = false;

      try {
        const rRef = roomRef(code);
        const rSnap = await withTimeout(getDoc(rRef), 6000, "getRoom");

        // 1) ë°© ìƒì„± + ë‚´ê°€ ë°©ì¥
        if (!rSnap.exists()) {
          const rolesConfig = getRolesConfigFromUI();
          if (Object.keys(rolesConfig).length === 0) {
            throw new Error("ìƒˆ ë°©ì€ ì—­í• ì„ í•˜ë‚˜ ì´ìƒ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.");
          }
          await withTimeout(setDoc(rRef, {
            hostId: myId,
            status: "waiting", // waiting | assigned
            rolesConfig,
            createdAt: Date.now()
          }), 6000, "createRoom");
          isHost = true;
        } else {
          const data = rSnap.data() || {};
          isHost = (data.hostId === myId);
        }

        // 2) roster(ê³µê°œ ëª©ë¡) ë“±ë¡
        await withTimeout(setDoc(rosterRef(code, myId), {
          name,
          isHost,
          joinedAt: Date.now()
        }, { merge: true }), 6000, "upsertRoster");

        // 3) privatePlayers(ë¹„ê³µê°œ ì—­í• ) ë“±ë¡
        const pRef = privateRef(code, myId);
        const pSnap = await withTimeout(getDoc(pRef), 6000, "getPrivateMe");
        
        if (!pSnap.exists()) {
          await withTimeout(setDoc(pRef, {
            name,
            role: null,
            isHost
          }), 6000, "createPrivateMe");
        } else {
          await withTimeout(updateDoc(pRef, { name, isHost }), 6000, "updatePrivateMe");
        }

        // UI ì „í™˜ ë° ë¦¬ìŠ¤ë„ˆ
        showLobbyScreen();
        listenRoomDoc();
        listenRoster();
        listenMyRole();
        if (isHost) listenAllRolesForHost();

      } catch (e) {
        console.error("Join Error:", e);
        await showAlert("ì…ì¥ ì‹¤íŒ¨:\n" + (e?.message || e));
        myRoom = "";
        isHost = false;
        showJoinScreen();
      } finally {
        setBusy(false);
      }
    }

    /* =========================
       7) ë¦¬ìŠ¤ë„ˆë“¤
    ========================== */
    function listenRoomDoc() {
      unsubRoom = onSnapshot(roomRef(myRoom), async (snap) => {
        if (!snap.exists()) {
          console.log("Room deleted");
          stopAllListeners();
          await showAlert(`ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          myRoom = "";
          isHost = false;
          showJoinScreen();
          return;
        }

        const data = snap.data() || {};
        const wasHost = isHost;
        isHost = (data.hostId === myId);

        // ë°©ì¥ì´ ë°”ë€Œì—ˆìœ¼ë©´ UI ê°±ì‹ 
        if (!wasHost && isHost) {
            showToast("ğŸ‘‘ ë‹¹ì‹ ì´ ì´ì œ ë°©ì¥ì…ë‹ˆë‹¤!");
            listenAllRolesForHost();
        }

        $("hostTag").textContent = isHost ? "ğŸ‘‘ ë‹¹ì‹ ì€ ë°©ì¥ì…ë‹ˆë‹¤" : "ğŸ™‚ ë‹¹ì‹ ì€ ì°¸ê°€ìì…ë‹ˆë‹¤";
        $("hostArea").style.display = isHost ? "block" : "none";

        let statusText = `ë°© ìƒíƒœ: ${data.status === 'assigned' ? 'ê²Œì„ ì§„í–‰ ì¤‘' : 'ëŒ€ê¸° ì¤‘'}`;
        if(isHost) statusText += " (ì°¸ê°€ìê°€ ë‹¤ ëª¨ì´ë©´ 'ì—­í•  ë¶€ì—¬'ë¥¼ ëˆ„ë¥´ì„¸ìš”)";
        setStatus(statusText);

      }, (err) => {
        console.error("Room listen error:", err);
      });
    }

    function listenRoster() {
      const q = query(collection(db, `rooms/${myRoom}/roster`));
      unsubRoster = onSnapshot(q, (snap) => {
        const list = [];
        snap.forEach(d => list.push(d.data()));
        list.sort((a,b) => (a.joinedAt || 0) - (b.joinedAt || 0));

        $("players").innerHTML = "";
        list.forEach((p) => {
          const li = document.createElement("li");
          li.textContent = p.name;
          if (p.isHost) li.innerHTML += " ğŸ‘‘";
          $("players").appendChild(li);
        });
      });
    }

    function listenMyRole() {
      unsubMyPrivate = onSnapshot(privateRef(myRoom, myId), (snap) => {
        const data = snap.data() || {};
        if (data.role) {
            $("myRole").textContent = `ğŸ­ ë‹¹ì‹ ì˜ ì—­í• : ${data.role}`;
            $("myRole").style.background = "#fff8e1";
        } else {
            $("myRole").textContent = "ì¤€ë¹„ ì¤‘... (ë°©ì¥ì´ ì—­í• ì„ ë¶€ì—¬í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤)";
            $("myRole").style.background = "#eee";
        }
      });
    }

    function listenAllRolesForHost() {
      if (unsubHostPrivate) unsubHostPrivate();
      
      unsubHostPrivate = onSnapshot(collection(db, `rooms/${myRoom}/privatePlayers`), (snap) => {
        const container = $("adminRoles");
        container.innerHTML = "<h4>ğŸ“‹ ì „ì²´ ì—­í•  (ë°©ì¥ë§Œ ë³´ì„)</h4>";
        
        let hasRoles = false;
        snap.forEach((d) => {
          const p = d.data() || {};
          if (p.role) {
            hasRoles = true;
            const div = document.createElement("div");
            div.style.borderBottom = "1px solid #ffcccc";
            div.style.padding = "4px 0";
            div.innerHTML = `<b>${p.name}</b> : ${p.role}`;
            container.appendChild(div);
          }
        });

        if (!hasRoles) {
            container.innerHTML += "<div class='muted'>ì•„ì§ ì—­í• ì´ ë¶€ì—¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>";
        }
      }, (err) => {
          console.log("Host role listen error (expected if not host):", err);
      });
    }

    /* =========================
       8) ì—­í•  ë¶€ì—¬ (ë°©ì¥)
    ========================== */
    async function assignRoles() {
      console.log(">> assignRoles clicked");
      if (!isHost) { await showAlert("ë°©ì¥ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
      
      setBusy(true);
      try {
        const rSnap = await getDoc(roomRef(myRoom));
        const config = rSnap.data().rolesConfig;

        const playersSnap = await getDocs(collection(db, `rooms/${myRoom}/privatePlayers`));
        
        const roles = [];
        Object.entries(config).forEach(([role, count]) => {
          for (let i = 0; i < count; i++) roles.push(role);
        });

        if (roles.length !== playersSnap.size) {
           throw new Error(`ì„¤ì •ëœ ì—­í•  ìˆ˜(${roles.length}ëª…)ì™€ í˜„ì¬ ì°¸ê°€ì ìˆ˜(${playersSnap.size}ëª…)ê°€ ë‹¤ë¦…ë‹ˆë‹¤.`);
        }

        shuffle(roles);

        const batch = writeBatch(db);
        let i = 0;
        playersSnap.forEach((docSnap) => {
          batch.update(docSnap.ref, { role: roles[i++] });
        });
        batch.update(roomRef(myRoom), { status: "assigned" });

        await batch.commit();
        showToast("âœ… ì—­í•  ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      } catch (e) {
        console.error(e);
        await showAlert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
      } finally {
        setBusy(false);
      }
    }

    /* =========================
       9) ë¦¬ì…‹ (ë°©ì¥)
    ========================== */
    async function resetRoom() {
      console.log(">> resetRoom clicked");
      if (!isHost) { await showAlert("ë°©ì¥ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
      
      const ok = await showConfirm("ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ëª¨ë“  ì—­í• ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤)");
      if (!ok) return;

      setBusy(true);
      try {
        const playersSnap = await getDocs(collection(db, `rooms/${myRoom}/privatePlayers`));
        const batch = writeBatch(db);

        // ëª¨ë“  í”Œë ˆì´ì–´ì˜ role í•„ë“œë¥¼ nullë¡œ ë³€ê²½
        playersSnap.forEach((docSnap) => {
          batch.update(docSnap.ref, { role: null });
        });
        
        // ë°© ìƒíƒœë¥¼ ëŒ€ê¸°ë¡œ ë³€ê²½
        batch.update(roomRef(myRoom), { status: "waiting" });

        await batch.commit();
        showToast("ğŸ”„ ê²Œì„ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // í™”ë©´ ì¦‰ì‹œ ë°˜ì˜ (í˜¹ì‹œ ë¦¬ìŠ¤ë„ˆê°€ ëŠë¦´ ê²½ìš°ë¥¼ ëŒ€ë¹„)
        setStatus("ë°© ìƒíƒœ: ëŒ€ê¸° ì¤‘ (ì°¸ê°€ìê°€ ë‹¤ ëª¨ì´ë©´ 'ì—­í•  ë¶€ì—¬'ë¥¼ ëˆ„ë¥´ì„¸ìš”)");
        
      } catch (e) {
        console.error("Reset Failed:", e);
        await showAlert("ë¦¬ì…‹ ì‹¤íŒ¨: " + e.message);
      } finally {
        setBusy(false);
      }
    }

    /* =========================
       10) ë‚˜ê°€ê¸°
    ========================== */
    async function deleteCollectionInChunks(colPath) {
      try {
        const qy = query(collection(db, colPath), limit(50));
        const snap = await getDocs(qy);
        if (snap.empty) return;
        
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        
        if (snap.size >= 50) await deleteCollectionInChunks(colPath);
      } catch (e) {
        console.warn(`Cleanup failed for ${colPath}:`, e);
      }
    }

    async function leaveRoom() {
      console.log(">> leaveRoom clicked");
      if (!myRoom) return;

      const msg = isHost 
        ? "ë°©ì¥ì´ ë‚˜ê°€ë©´ ë°©ì´ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" 
        : "ì •ë§ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?";
      
      const ok = await showConfirm(msg);
      if (!ok) return;

      setBusy(true);
      try {
        if (isHost) {
            console.log("Host leaving -> Destroying room");
            await deleteCollectionInChunks(`rooms/${myRoom}/roster`);
            await deleteCollectionInChunks(`rooms/${myRoom}/privatePlayers`);
            await deleteDoc(roomRef(myRoom));
        } else {
            console.log("Guest leaving -> Deleting self");
            const batch = writeBatch(db);
            batch.delete(rosterRef(myRoom, myId));
            batch.delete(privateRef(myRoom, myId));
            await batch.commit();
        }

        console.log("Leave successful");
        stopAllListeners();
        myRoom = "";
        isHost = false;
        showJoinScreen();
        showToast("ë°©ì—ì„œ ë‚˜ì™”ìŠµë‹ˆë‹¤.");

      } catch (e) {
        console.error("ë‚˜ê°€ê¸° ì˜¤ë¥˜", e);
        await showAlert("ë‚˜ê°€ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
      } finally {
        setBusy(false);
      }
    }

    /* =========================
       11) ì´ˆê¸°í™”
    ========================== */
    document.addEventListener("DOMContentLoaded", async () => {
      showJoinScreen();
      setBusy(true);
      $("authStatus").textContent = "ë¡œê·¸ì¸ ì‹œë„ ì¤‘...";

      $("roomInput").addEventListener("input", onRoomInputChange);
      $("joinBtn").addEventListener("click", joinRoom);
      $("leaveBtn").addEventListener("click", leaveRoom);
      $("assignBtn").addEventListener("click", assignRoles);
      $("resetBtn").addEventListener("click", resetRoom);
      $("addRoleBtn").addEventListener("click", addRoleRow);

      document.querySelectorAll(".removeRoleBtn").forEach((btn) => {
        btn.addEventListener("click", () => btn.closest(".roleRow")?.remove());
      });

      try {
        await signInAnonymously(auth);
        myId = auth.currentUser.uid;
        console.log("Logged in as:", myId);
        $("authStatus").textContent = `ë¡œê·¸ì¸ ì™„ë£Œ (UID: ${myId.slice(0,5)}..)`;
      } catch (e) {
        console.error(e);
        $("authStatus").textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨. Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.";
      } finally {
        setBusy(false);
      }
    });
  </script>
</head>

<body>
  <div id="toast"></div>

  <!-- Custom Modal HTML -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
      <div id="modalMsg" class="modal-msg"></div>
      <div class="modal-btns">
        <button id="modalCancelBtn" class="ghost">ì·¨ì†Œ</button>
        <button id="modalOkBtn" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <h1>ğŸ•µï¸ ë§ˆí”¼ì•„ ì—­í•  ë¶€ì—¬</h1>
  <div id="authStatus" class="muted"></div>

  <!-- JOIN SCREEN -->
  <div id="join" class="box">
    <div class="row">
      <input id="nameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10" />
      <input id="roomInput" placeholder="ë°© ì½”ë“œ (ì˜ˆ: 1234)" maxlength="10" />
    </div>
    <div class="row">
      <button id="joinBtn" class="primary" style="width:100px;">ì…ì¥</button>
    </div>

    <div id="hint"></div>

    <!-- ROLE SETUP (Only visible for new rooms) -->
    <div id="roleSetup" class="box">
      <h3>ğŸ­ ì—­í•  ì„¤ì • (ë°©ì¥)</h3>
      <p class="muted" style="margin-bottom:10px;">ì°¸ê°€ì ìˆ˜ì— ë§ì¶° ì—­í• ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
      
      <div id="roles">
        <div class="roleRow">
          <input class="roleName" type="text" value="ë§ˆí”¼ì•„"/>
          <input class="roleCount" type="number" min="1" value="1"/>
          <button class="ghost removeRoleBtn" type="button">ğŸ—‘ï¸</button>
        </div>
        <div class="roleRow">
          <input class="roleName" type="text" value="ì‹œë¯¼"/>
          <input class="roleCount" type="number" min="1" value="2"/>
          <button class="ghost removeRoleBtn" type="button">ğŸ—‘ï¸</button>
        </div>
      </div>
      
      <button id="addRoleBtn" class="ghost" type="button" style="margin-top:10px; width:100%;">â• ì—­í•  ì¶”ê°€</button>
    </div>
  </div>

  <!-- LOBBY SCREEN -->
  <div id="lobby" class="box">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h2 style="margin:0;">ê²Œì„ ëŒ€ê¸°ì‹¤</h2>
      <button id="leaveBtn" class="danger" style="font-size:12px; padding:6px 12px;">ğŸšª ë‚˜ê°€ê¸°</button>
    </div>
    
    <p id="hostTag" style="font-weight:bold; color:#2980b9;"></p>

    <!-- Host Controls -->
    <div id="hostArea">
      <button id="assignBtn" class="primary">ğŸ² ì—­í•  ëœë¤ ë¶€ì—¬</button>
      <button id="resetBtn" class="ghost">ğŸ”„ ë¦¬ì…‹</button>
    </div>

    <div id="roomStatus"></div>

    <h3 style="margin-top:20px; text-align:left; border-bottom:2px solid #eee; padding-bottom:5px;">
      ğŸ‘¥ ì°¸ê°€ì ëª©ë¡
    </h3>
    <ul id="players"></ul>

    <!-- My Role Display -->
    <div id="myRole"></div>
    
    <!-- Admin View -->
    <div id="adminRoles"></div>
  </div>
</body>
</html>
