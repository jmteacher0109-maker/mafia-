<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§ˆí”¼ì•„ ì—­í•  ë¶€ì—¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    input, button { padding: 8px; margin: 5px; }
    #lobby { display: none; } /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
    #assignBtn { display: none; }
    #myRole { font-size: 20px; margin-top: 15px; }
    #admin { margin-top: 15px; color: darkred; }
    #authStatus { font-size: 12px; opacity: 0.8; margin-bottom: 10px; }
    #joinHint { font-size: 12px; opacity: 0.85; margin-top: 6px; }
    #roleSetup { margin-top: 12px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      getDocs,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // âœ… ë³¸ì¸ Firebase ì„¤ì •ìœ¼ë¡œ êµì²´
    const firebaseConfig = {
  apiKey: "AIzaSyBCI97ApSsXtNqUnKTdzEW6bvtaF-bHrgs",
  authDomain: "role-class.firebaseapp.com",
  projectId: "role-class",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let myId = null;
    let myRoomCode = "";
    let isHost = false;
    let roomExists = null; // null(ëª¨ë¦„) / true(ì¡´ì¬) / false(ì—†ìŒ)

    function $(id){ return document.getElementById(id); }

    function showJoin() {
      $("join").style.display = "block";
      $("lobby").style.display = "none";
      $("assignBtn").style.display = "none";
      $("myRole").innerText = "";
      $("admin").innerHTML = "";
      $("players").innerHTML = "";
    }

    function showLobby() {
      $("join").style.display = "none";
      $("lobby").style.display = "block";
    }

    function setAuthStatus(t) { $("authStatus").textContent = t; }
    function setJoinHint(t) { $("joinHint").textContent = t; }

    function setJoinEnabled(v) { $("joinBtn").disabled = !v; }

    function setRoleSetupVisible(v) {
      // ë°©ì´ "ì—†ì„ ë•Œ"ë§Œ (ìƒˆ ë°© ìƒì„±/ë°©ì¥ì¼ ë•Œ) ì—­í•  ì„¤ì •ì„ ë³´ì—¬ì¤Œ
      $("roleSetup").style.display = v ? "block" : "none";
    }

    // âœ… í˜ì´ì§€ ì‹œì‘ ì‹œ ë¬´ì¡°ê±´ "ì…ì¥ í™”ë©´"ì´ ë¨¼ì € ë³´ì´ê²Œ ê°•ì œ
    window.addEventListener("DOMContentLoaded", () => {
      showJoin();
      setRoleSetupVisible(false); // ë°© ì¡´ì¬ ì—¬ë¶€ë¥¼ ëª¨ë¥´ë‹ˆ ì¼ë‹¨ ìˆ¨ê¹€
      setJoinEnabled(false);
      setAuthStatus("ë¡œê·¸ì¸ ì¤‘...");
      setJoinHint("ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ìƒˆ ë°©ì¸ì§€/ê¸°ì¡´ ë°©ì¸ì§€ ì•ˆë‚´í•´ìš”.");
    });

    // âœ… ìµëª… ë¡œê·¸ì¸
    signInAnonymously(auth)
      .then(() => {
        myId = auth.currentUser.uid;
        setAuthStatus("ë¡œê·¸ì¸ ì™„ë£Œ âœ…");
        setJoinEnabled(true);
      })
      .catch((e) => {
        console.error(e);
        setAuthStatus("ë¡œê·¸ì¸ ì‹¤íŒ¨ âŒ");
        alert("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨: Firebase Authenticationì—ì„œ ìµëª… ë¡œê·¸ì¸ì„ ì¼°ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n" + (e?.message || e));
      });

    // ì—­í•  ì„¤ì • ì½ê¸°
    function getRolesConfigFromInputs() {
      const names = document.querySelectorAll(".roleName");
      const counts = document.querySelectorAll(".roleCount");

      const config = {};
      names.forEach((n, i) => {
        const role = n.value.trim();
        const count = parseInt(counts[i].value, 10);
        if (role && Number.isFinite(count) && count > 0) config[role] = count;
      });
      return config;
    }

    // moduleì—ì„œ onclick ì“°ë ¤ë©´ windowì— ë…¸ì¶œ
    window.addRole = function () {
      const rolesDiv = $("roles");
      const div = document.createElement("div");
      div.innerHTML = `
        <input placeholder="ì—­í•  ì´ë¦„" class="roleName" />
        <input type="number" min="1" value="1" class="roleCount" />
      `;
      rolesDiv.appendChild(div);
    };

    // âœ… ë°© ì½”ë“œ ì…ë ¥ ì‹œ: ë°©ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ â†’ ì—­í•  ì„¤ì • UI í‘œì‹œ/ìˆ¨ê¹€
    let roomCheckTimer = null;
    window.onRoomCodeInput = function () {
      const roomCode = $("room").value.trim();

      if (!myId) {
        setJoinHint("ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤...");
        setRoleSetupVisible(false);
        return;
      }

      if (!roomCode) {
        roomExists = null;
        setJoinHint("ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        setRoleSetupVisible(false);
        return;
      }

      clearTimeout(roomCheckTimer);
      roomCheckTimer = setTimeout(async () => {
        try {
          const roomRef = doc(db, "rooms", roomCode);
          const snap = await getDoc(roomRef);

          if (snap.exists()) {
            roomExists = true;
            setJoinHint("âœ… ê¸°ì¡´ ë°©ì…ë‹ˆë‹¤. ì—­í•  ì„¤ì • ì—†ì´ ì…ì¥í•©ë‹ˆë‹¤.");
            setRoleSetupVisible(false); // ê¸°ì¡´ ë°©ì´ë©´ ì—­í•  ì„¤ì • ìˆ¨ê¹€
          } else {
            roomExists = false;
            setJoinHint("ğŸ†• ìƒˆ ë°©ì…ë‹ˆë‹¤. ì²« ì…ì¥ìëŠ” ë°©ì¥(ì—­í•  ì„¤ì • í•„ìš”)ì…ë‹ˆë‹¤.");
            setRoleSetupVisible(true); // ìƒˆ ë°©ì´ë©´ ì—­í•  ì„¤ì • í‘œì‹œ
          }
        } catch (e) {
          console.error("ë°© ì¡´ì¬ í™•ì¸ ì˜¤ë¥˜", e);
          setJoinHint("ë°© í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
      }, 250); // ê°„ë‹¨ ë””ë°”ìš´ìŠ¤
    };

    // ë°© ì…ì¥
    window.joinRoom = async () => {
      try {
        if (!myId) {
          alert("ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
          return;
        }

        const name = $("name").value.trim();
        const roomCode = $("room").value.trim();
        if (!name || !roomCode) {
          alert("ì´ë¦„ê³¼ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        myRoomCode = roomCode;

        const roomRef = doc(db, "rooms", roomCode);
        const roomSnap = await getDoc(roomRef);

        // ë°© ìƒì„±(ë°©ì¥)
        if (!roomSnap.exists()) {
          const rolesConfig = getRolesConfigFromInputs();
          if (Object.keys(rolesConfig).length === 0) {
            alert("ìƒˆ ë°©(ë°©ì¥)ì€ ì—­í• ì„ í•˜ë‚˜ ì´ìƒ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
          }

          await setDoc(roomRef, {
            hostId: myId,
            status: "waiting",
            rolesConfig
          });

          isHost = true;
        } else {
          const roomData = roomSnap.data();
          isHost = (roomData?.hostId === myId);
        }

        // í”Œë ˆì´ì–´ ë¬¸ì„œ ìƒì„±/ê°±ì‹ 
        const playerRef = doc(db, `rooms/${roomCode}/players`, myId);
        const playerSnap = await getDoc(playerRef);

        if (!playerSnap.exists()) {
          await setDoc(playerRef, { name, role: null, isHost });
        } else {
          await updateDoc(playerRef, { name }); // role ê±´ë“œë¦¬ì§€ ì•ŠìŒ
        }

        // âœ… ì´ì œì„œì•¼ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™
        showLobby();

        $("hostTag").innerText = isHost ? "ğŸ‘‘ ë°©ì¥ì…ë‹ˆë‹¤" : "ì°¸ê°€ìì…ë‹ˆë‹¤";
        $("assignBtn").style.display = isHost ? "inline-block" : "none";

        listenPlayers();
        listenMyRole();
      } catch (e) {
        console.error("joinRoom ì—ëŸ¬", e);
        alert("ì…ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:\n" + (e?.code || "") + "\n" + (e?.message || e));
      }
    };

    // í”Œë ˆì´ì–´ ëª©ë¡ + ë°©ì¥ ì „ì²´ ì—­í•  í‘œì‹œ
    function listenPlayers() {
      const list = $("players");
      const admin = $("admin");
      const ref = collection(db, `rooms/${myRoomCode}/players`);

      onSnapshot(ref, (snap) => {
        list.innerHTML = "";
        admin.innerHTML = "";

        snap.forEach((d) => {
          const p = d.data();
          const li = document.createElement("li");
          li.innerText = p.name + (p.isHost ? " â­" : "");
          list.appendChild(li);

          if (isHost && p.role) {
            const r = document.createElement("div");
            r.innerText = `${p.name} : ${p.role}`;
            admin.appendChild(r);
          }
        });
      }, (err) => {
        console.error("listenPlayers ì˜¤ë¥˜", err);
        alert("í”Œë ˆì´ì–´ ëª©ë¡ ì˜¤ë¥˜:\n" + (err?.message || err));
      });
    }

    // ë‚´ ì—­í• ë§Œ í™•ì¸
    function listenMyRole() {
      const ref = doc(db, `rooms/${myRoomCode}/players`, myId);
      onSnapshot(ref, (snap) => {
        const data = snap.data();
        if (data?.role) $("myRole").innerText = `ğŸ­ ë‹¹ì‹ ì˜ ì—­í• : ${data.role}`;
      }, (err) => {
        console.error("listenMyRole ì˜¤ë¥˜", err);
        alert("ë‚´ ì—­í•  êµ¬ë… ì˜¤ë¥˜:\n" + (err?.message || err));
      });
    }

    // ì—­í•  ë¶€ì—¬(ë°©ì¥)
    window.assignRoles = async () => {
      try {
        if (!isHost) {
          alert("ë°©ì¥ë§Œ ì—­í• ì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        const roomRef = doc(db, "rooms", myRoomCode);
        const roomSnap = await getDoc(roomRef);
        const roomData = roomSnap.data() || {};

        const config = roomData.rolesConfig || roomData.roles;
        if (!config) {
          alert("ì—­í•  ì„¤ì •ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        let roles = [];
        Object.entries(config).forEach(([role, count]) => {
          const n = parseInt(count, 10);
          for (let i = 0; i < n; i++) roles.push(role);
        });

        const playersSnap = await getDocs(collection(db, `rooms/${myRoomCode}/players`));

        if (roles.length !== playersSnap.size) {
          alert(`âš ï¸ ì—­í•  ìˆ˜(${roles.length})ì™€ ì°¸ê°€ì ìˆ˜(${playersSnap.size})ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
          return;
        }

        shuffle(roles);

        let i = 0;
        for (const pDoc of playersSnap.docs) {
          await updateDoc(pDoc.ref, { role: roles[i++] });
        }

        await updateDoc(roomRef, { status: "assigned" });
      } catch (e) {
        console.error("assignRoles ì—ëŸ¬", e);
        alert("ì—­í•  ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜:\n" + (e?.code || "") + "\n" + (e?.message || e));
      }
    };

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
  </script>
</head>

<body>
  <h1>ğŸ•µï¸ ë§ˆí”¼ì•„ ì—­í•  ë¶€ì—¬</h1>
  <div id="authStatus">ë¡œê·¸ì¸ ìƒíƒœ</div>

  <!-- âœ… ì…ì¥ í™”ë©´(ì²˜ìŒì— ë¬´ì¡°ê±´ ë³´ì„) -->
  <div id="join" style="display:block;">
    <input id="name" placeholder="ì´ë¦„" />
    <input id="room" placeholder="ë°© ì½”ë“œ" oninput="onRoomCodeInput()" />
    <br />
    <button id="joinBtn" onclick="joinRoom()">ì…ì¥í•˜ê¸°</button>
    <div id="joinHint"></div>

    <!-- âœ… ìƒˆ ë°©ì¼ ë•Œë§Œ ë³´ì—¬ì¤„ ì—­í•  ì„¤ì • -->
    <div id="roleSetup" style="display:none;">
      <h3>ğŸ­ ì—­í•  ì„¤ì • (ìƒˆ ë°© ìƒì„± ì‹œ ë°©ì¥ë§Œ)</h3>
      <div id="roles">
        <div>
          <input value="ë§ˆí”¼ì•„" class="roleName" />
          <input type="number" min="1" value="1" class="roleCount" />
        </div>
        <div>
          <input value="ì‹œë¯¼" class="roleName" />
          <input type="number" min="1" value="2" class="roleCount" />
        </div>
      </div>
      <button onclick="addRole()">â• ì—­í•  ì¶”ê°€</button>
      <div style="font-size:12px;opacity:.8;margin-top:6px;">
        â€» ì—­í•  ì¸ì› í•©ê³„ = ì°¸ê°€ì ìˆ˜ê°€ ë˜ì–´ì•¼ ì—­í•  ë¶€ì—¬ê°€ ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- âœ… ëŒ€ê¸°ì‹¤(ì²˜ìŒì—” ë¬´ì¡°ê±´ ìˆ¨ê¹€) -->
  <div id="lobby" style="display:none;">
    <h2>ëŒ€ê¸°ì‹¤</h2>
    <p id="hostTag"></p>
    <button id="assignBtn" onclick="assignRoles()">ğŸ² ì—­í•  ë¶€ì—¬</button>

    <ul id="players"></ul>
    <div id="myRole"></div>
    <div id="admin"></div>
  </div>
</body>
</html>
